name: ë°°í¬ íŒŒì´í”„ë¼ì¸

on:
  push:
    branches: [main]
  workflow_run:
    workflows: ["Continuous Integration"]
    types: [completed]
    branches: [main]

# GitHub Pages ë°°í¬ë¥¼ ìœ„í•œ ê¶Œí•œ ì„¤ì •
permissions:
  contents: read
  pages: write
  id-token: write
  deployments: write

# ë™ì‹œ ë°°í¬ ì œí•œ - ì§„í–‰ ì¤‘ì¸ ë°°í¬ëŠ” ì·¨ì†Œí•˜ì§€ ì•ŠìŒ
concurrency:
  group: "deployment"
  cancel-in-progress: false

jobs:
  # ë°°í¬ ì „ ê²€ì¦
  pre-deployment-checks:
    name: ë°°í¬ ì „ ê²€ì¦
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'push'
    timeout-minutes: 10
    
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ë¹Œë“œ í…ŒìŠ¤íŠ¸
        run: npm run build

      - name: ë°°í¬ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
        id: check
        run: |
          if [ -f "dist/index.js" ] && [ -f "package.json" ]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… ë°°í¬ ì¤€ë¹„ ì™„ë£Œ"
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
            echo "âŒ ë°°í¬ ì¤€ë¹„ ë¯¸ì™„ë£Œ"
            exit 1
          fi

      - name: ë²„ì „ ì •ë³´ ì¶”ì¶œ
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ë°°í¬ ë²„ì „: $VERSION"

  # ìŠ¤í…Œì´ì§• í™˜ê²½ ë°°í¬
  deploy-staging:
    name: ìŠ¤í…Œì´ì§• ë°°í¬
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    if: needs.pre-deployment-checks.outputs.should-deploy == 'true'
    timeout-minutes: 15
    
    environment:
      name: staging
      url: https://eai-schema-staging.herokuapp.com
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: í”„ë¡œë•ì…˜ ë¹Œë“œ
        run: npm run build

      - name: Heroku CLI ì„¤ì¹˜
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh

      - name: ìŠ¤í…Œì´ì§• í™˜ê²½ ë°°í¬
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_STAGING_APP: eai-schema-staging
        run: |
          echo "machine api.heroku.com login _ password $HEROKU_API_KEY" > ~/.netrc
          echo "machine git.heroku.com login _ password $HEROKU_API_KEY" >> ~/.netrc
          chmod 600 ~/.netrc
          
          heroku git:remote -a "$HEROKU_STAGING_APP"
          
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          git add -f dist/ package.json package-lock.json Procfile app.json
          git commit -m "Deploy v${{ needs.pre-deployment-checks.outputs.version }} to staging [skip ci]" || echo "No changes to commit"
          
          git push heroku HEAD:main --force

      - name: ìŠ¤í…Œì´ì§• í—¬ìŠ¤ì²´í¬
        run: |
          echo "ìŠ¤í…Œì´ì§• í™˜ê²½ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘..."
          sleep 30
          
          for i in {1..10}; do
            if curl -f -s https://eai-schema-staging.herokuapp.com/health > /dev/null; then
              echo "âœ… ìŠ¤í…Œì´ì§• í™˜ê²½ ì •ìƒ ì‘ë™"
              exit 0
            fi
            echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/10 ì‹¤íŒ¨, 10ì´ˆ í›„ ì¬ì‹œë„..."
            sleep 10
          done
          
          echo "âŒ ìŠ¤í…Œì´ì§• í™˜ê²½ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          exit 1

  # ìŠ¤í…Œì´ì§• í™˜ê²½ í…ŒìŠ¤íŠ¸
  staging-tests:
    name: ìŠ¤í…Œì´ì§• í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: deploy-staging
    timeout-minutes: 20
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ìŠ¤í…Œì´ì§• í™˜ê²½ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸
        run: |
          echo "ìŠ¤í…Œì´ì§• í™˜ê²½ API í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
          
          # ê¸°ë³¸ í—¬ìŠ¤ì²´í¬
          curl -f https://eai-schema-staging.herokuapp.com/health
          
          # API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
          curl -f https://eai-schema-staging.herokuapp.com/api/v1/health
          
          # ë©”íŠ¸ë¦­ ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
          curl -f https://eai-schema-staging.herokuapp.com/metrics
          
          echo "âœ… ìŠ¤í…Œì´ì§• í™˜ê²½ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ í†µê³¼"

      - name: ì„±ëŠ¥ ê¸°ì¤€ì„  í…ŒìŠ¤íŠ¸
        run: |
          echo "ì„±ëŠ¥ ê¸°ì¤€ì„  í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
          npx autocannon -c 10 -d 30 https://eai-schema-staging.herokuapp.com/health
        continue-on-error: true

  # GitHub Pages ë°°í¬ (ë¬¸ì„œ)
  deploy-docs:
    name: ë¬¸ì„œ ë°°í¬
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    if: needs.pre-deployment-checks.outputs.should-deploy == 'true'
    timeout-minutes: 10
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ë¬¸ì„œ ë¹Œë“œ
        run: |
          npm run build
          mkdir -p _site
          cp -r docs/* _site/
          
          # API ë¬¸ì„œ ìƒì„± (Swagger)
          if [ -f "dist/index.js" ]; then
            echo "API ë¬¸ì„œ ìƒì„± ì¤‘..."
            # API ë¬¸ì„œ ìƒì„± ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
          fi

      - name: GitHub Pages ì„¤ì •
        uses: actions/configure-pages@v4

      - name: ë¬¸ì„œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: GitHub Pages ë°°í¬
        id: deployment
        uses: actions/deploy-pages@v4

  # í”„ë¡œë•ì…˜ ë°°í¬
  deploy-production:
    name: í”„ë¡œë•ì…˜ ë°°í¬
    runs-on: ubuntu-latest
    needs: [staging-tests, deploy-docs]
    timeout-minutes: 20
    
    environment:
      name: production
      url: https://eai-schema-api.herokuapp.com
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: í”„ë¡œë•ì…˜ ë¹Œë“œ
        run: npm run build

      - name: Heroku CLI ì„¤ì¹˜
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh

      - name: í”„ë¡œë•ì…˜ ë°°í¬
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_PRODUCTION_APP: eai-schema-api
        run: |
          echo "machine api.heroku.com login _ password $HEROKU_API_KEY" > ~/.netrc
          echo "machine git.heroku.com login _ password $HEROKU_API_KEY" >> ~/.netrc
          chmod 600 ~/.netrc
          
          heroku git:remote -a "$HEROKU_PRODUCTION_APP"
          
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          
          git add -f dist/ package.json package-lock.json Procfile app.json
          git commit -m "Deploy v${{ needs.pre-deployment-checks.outputs.version }} to production [skip ci]" || echo "No changes to commit"
          
          git push heroku HEAD:main --force

      - name: í”„ë¡œë•ì…˜ í—¬ìŠ¤ì²´í¬
        run: |
          echo "í”„ë¡œë•ì…˜ í™˜ê²½ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘..."
          sleep 60
          
          for i in {1..15}; do
            if curl -f -s https://eai-schema-api.herokuapp.com/health > /dev/null; then
              echo "âœ… í”„ë¡œë•ì…˜ í™˜ê²½ ì •ìƒ ì‘ë™"
              exit 0
            fi
            echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/15 ì‹¤íŒ¨, 15ì´ˆ í›„ ì¬ì‹œë„..."
            sleep 15
          done
          
          echo "âŒ í”„ë¡œë•ì…˜ í™˜ê²½ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          exit 1

      - name: ë°°í¬ ì•Œë¦¼
        if: success()
        run: |
          echo "## ğŸš€ ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "ë²„ì „: v${{ needs.pre-deployment-checks.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "í”„ë¡œë•ì…˜ URL: https://eai-schema-api.herokuapp.com" >> $GITHUB_STEP_SUMMARY
          echo "ë¬¸ì„œ URL: ${{ needs.deploy-docs.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "ë°°í¬ ì‹œê°„: $(date -u)" >> $GITHUB_STEP_SUMMARY

  # ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§
  post-deployment-monitoring:
    name: ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§
    runs-on: ubuntu-latest
    needs: deploy-production
    if: success()
    timeout-minutes: 10
    
    steps:
      - name: í”„ë¡œë•ì…˜ ëª¨ë‹ˆí„°ë§ ì„¤ì •
        run: |
          echo "ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§ ì‹œì‘..."
          
          # 5ë¶„ê°„ í—¬ìŠ¤ì²´í¬ ëª¨ë‹ˆí„°ë§
          for i in {1..5}; do
            if curl -f -s https://eai-schema-api.herokuapp.com/health > /dev/null; then
              echo "ëª¨ë‹ˆí„°ë§ $i/5: âœ… ì •ìƒ"
            else
              echo "ëª¨ë‹ˆí„°ë§ $i/5: âŒ ì˜¤ë¥˜ ê°ì§€"
              # ì•Œë¦¼ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
            fi
            sleep 60
          done
          
          echo "âœ… ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§ ì™„ë£Œ"

      - name: ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
        run: |
          echo "ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì¤‘..."
          curl -s https://eai-schema-api.herokuapp.com/metrics | head -20
        continue-on-error: true