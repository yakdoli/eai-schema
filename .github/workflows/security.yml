name: ë³´ì•ˆ ìŠ¤ìº”

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 2ì‹œ (UTC) ì •ê¸° ë³´ì•ˆ ìŠ¤ìº”
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ì˜ì¡´ì„± ì·¨ì•½ì  ìŠ¤ìº”
  dependency-scan:
    name: ì˜ì¡´ì„± ì·¨ì•½ì  ìŠ¤ìº”
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: npm audit ì‹¤í–‰
        run: |
          echo "## ðŸ“¦ npm audit ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=moderate --json > audit-results.json || true
          
          # ì·¨ì•½ì  ìš”ì•½ ìƒì„±
          if [ -f "audit-results.json" ]; then
            VULNERABILITIES=$(node -p "
              const audit = JSON.parse(require('fs').readFileSync('audit-results.json', 'utf8'));
              const meta = audit.metadata || {};
              const vuln = meta.vulnerabilities || {};
              \`| ì‹¬ê°ë„ | ê°œìˆ˜ |
|--------|------|
| Critical | \${vuln.critical || 0} |
| High | \${vuln.high || 0} |
| Moderate | \${vuln.moderate || 0} |
| Low | \${vuln.low || 0} |\`
            " 2>/dev/null || echo "audit ê²°ê³¼ íŒŒì‹± ì‹¤íŒ¨")
            
            echo "$VULNERABILITIES" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Snyk ë³´ì•ˆ ìŠ¤ìº”
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json-file-output=snyk-results.json
        continue-on-error: true

      - name: Snyk ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-results.json
        continue-on-error: true

      - name: ì·¨ì•½ì  ë³´ê³ ì„œ ìƒì„±
        if: always()
        run: |
          echo "## ðŸ” ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "ìŠ¤ìº” ì™„ë£Œ ì‹œê°„: $(date -u)" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "snyk-results.json" ]; then
            echo "Snyk ìŠ¤ìº” ê²°ê³¼ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi

  # ì½”ë“œ ë³´ì•ˆ ë¶„ì„ (CodeQL)
  codeql-analysis:
    name: CodeQL ë³´ì•ˆ ë¶„ì„
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    strategy:
      fail-fast: false
      matrix:
        language: ['javascript']
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: CodeQL ì´ˆê¸°í™”
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended,security-and-quality

      - name: ìžë™ ë¹Œë“œ
        uses: github/codeql-action/autobuild@v3

      - name: CodeQL ë¶„ì„ ì‹¤í–‰
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

  # ì‹œí¬ë¦¿ ìŠ¤ìº”
  secret-scan:
    name: ì‹œí¬ë¦¿ ìŠ¤ìº”
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog ì‹œí¬ë¦¿ ìŠ¤ìº”
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

      - name: GitLeaks ì‹œí¬ë¦¿ ìŠ¤ìº”
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          config-path: .gitleaks.toml
        continue-on-error: true

  # ì»¨í…Œì´ë„ˆ ë³´ì•ˆ ìŠ¤ìº” (Docker ì´ë¯¸ì§€ê°€ ìžˆëŠ” ê²½ìš°)
  container-scan:
    name: ì»¨í…Œì´ë„ˆ ë³´ì•ˆ ìŠ¤ìº”
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
        run: |
          if [ -f "Dockerfile" ]; then
            docker build -t eai-schema-toolkit:latest .
          else
            echo "Dockerfileì´ ì—†ì–´ ì»¨í…Œì´ë„ˆ ìŠ¤ìº”ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi

      - name: Trivy ì»¨í…Œì´ë„ˆ ìŠ¤ìº”
        if: hashFiles('Dockerfile') != ''
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'eai-schema-toolkit:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Trivy ê²°ê³¼ ì—…ë¡œë“œ
        if: hashFiles('Dockerfile') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

  # ë¼ì´ì„¼ìŠ¤ ì»´í”Œë¼ì´ì–¸ìŠ¤ ê²€ì‚¬
  license-check:
    name: ë¼ì´ì„¼ìŠ¤ ì»´í”Œë¼ì´ì–¸ìŠ¤
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ë¼ì´ì„¼ìŠ¤ ê²€ì‚¬
        run: |
          # license-checker ì„¤ì¹˜ ë° ì‹¤í–‰
          npx license-checker --json --out licenses.json || true
          
          if [ -f "licenses.json" ]; then
            echo "## ðŸ“„ ë¼ì´ì„¼ìŠ¤ ê²€ì‚¬ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
            
            # ê¸ˆì§€ëœ ë¼ì´ì„¼ìŠ¤ í™•ì¸
            FORBIDDEN_LICENSES="GPL-2.0,GPL-3.0,AGPL-1.0,AGPL-3.0"
            
            node -e "
              const licenses = JSON.parse(require('fs').readFileSync('licenses.json', 'utf8'));
              const forbidden = '$FORBIDDEN_LICENSES'.split(',');
              let issues = [];
              
              Object.entries(licenses).forEach(([pkg, info]) => {
                if (forbidden.some(f => info.licenses && info.licenses.includes(f))) {
                  issues.push(\`- \${pkg}: \${info.licenses}\`);
                }
              });
              
              if (issues.length > 0) {
                console.log('âŒ ê¸ˆì§€ëœ ë¼ì´ì„¼ìŠ¤ ë°œê²¬:');
                issues.forEach(issue => console.log(issue));
                process.exit(1);
              } else {
                console.log('âœ… ë¼ì´ì„¼ìŠ¤ ì»´í”Œë¼ì´ì–¸ìŠ¤ í†µê³¼');
              }
            "
          fi

  # OWASP ZAP ë™ì  ë³´ì•ˆ í…ŒìŠ¤íŠ¸
  dynamic-security-test:
    name: ë™ì  ë³´ì•ˆ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    services:
      app:
        image: node:22-alpine
        ports:
          - 3000:3000
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜ ë° ì•± ì‹œìž‘
        run: |
          npm ci
          npm run build
          npm start &
          
          # ì•±ì´ ì‹œìž‘ë  ë•Œê¹Œì§€ ëŒ€ê¸°
          for i in {1..30}; do
            if curl -f http://localhost:3000/health > /dev/null 2>&1; then
              echo "ì•±ì´ ì‹œìž‘ë˜ì—ˆìŠµë‹ˆë‹¤."
              break
            fi
            echo "ì•± ì‹œìž‘ ëŒ€ê¸° ì¤‘... ($i/30)"
            sleep 2
          done

      - name: OWASP ZAP ë² ì´ìŠ¤ë¼ì¸ ìŠ¤ìº”
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
        continue-on-error: true

      - name: ZAP ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: report_html.html
          retention-days: 7

  # ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ìš”ì•½
  security-summary:
    name: ë³´ì•ˆ ìŠ¤ìº” ìš”ì•½
    runs-on: ubuntu-latest
    needs: [dependency-scan, codeql-analysis, secret-scan, license-check]
    if: always()
    
    steps:
      - name: ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ìš”ì•½
        run: |
          echo "## ðŸ›¡ï¸ ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "| ìŠ¤ìº” ìœ í˜• | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ì˜ì¡´ì„± ì·¨ì•½ì  | ${{ needs.dependency-scan.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL ë¶„ì„ | ${{ needs.codeql-analysis.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì‹œí¬ë¦¿ ìŠ¤ìº” | ${{ needs.secret-scan.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¼ì´ì„¼ìŠ¤ ê²€ì‚¬ | ${{ needs.license-check.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ìŠ¤ìº” ì™„ë£Œ ì‹œê°„: $(date -u)" >> $GITHUB_STEP_SUMMARY

      - name: ë³´ì•ˆ ì´ìŠˆ ì•Œë¦¼
        if: needs.dependency-scan.result == 'failure' || needs.codeql-analysis.result == 'failure' || needs.secret-scan.result == 'failure'
        run: |
          echo "## âš ï¸ ë³´ì•ˆ ì´ìŠˆ ë°œê²¬" >> $GITHUB_STEP_SUMMARY
          echo "ë³´ì•ˆ ìŠ¤ìº”ì—ì„œ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          echo "Security íƒ­ì—ì„œ ìžì„¸í•œ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY