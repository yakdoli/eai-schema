name: ë¡¤ë°± ì‹œìŠ¤í…œ

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë¡¤ë°±í•  í™˜ê²½'
        required: true
        type: choice
        options:
          - staging
          - production
      version:
        description: 'ë¡¤ë°±í•  ë²„ì „ (ì˜ˆ: v1.2.3 ë˜ëŠ” ì»¤ë°‹ í•´ì‹œ)'
        required: true
        type: string
      reason:
        description: 'ë¡¤ë°± ì‚¬ìœ '
        required: true
        type: string

permissions:
  contents: read
  deployments: write

jobs:
  # ë¡¤ë°± ì „ ê²€ì¦
  pre-rollback-validation:
    name: ë¡¤ë°± ì „ ê²€ì¦
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      target-commit: ${{ steps.validate.outputs.target-commit }}
      current-version: ${{ steps.validate.outputs.current-version }}
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ë¡¤ë°± ëŒ€ìƒ ê²€ì¦
        id: validate
        run: |
          echo "ë¡¤ë°± ìš”ì²­ ì •ë³´:"
          echo "- í™˜ê²½: ${{ github.event.inputs.environment }}"
          echo "- ë²„ì „: ${{ github.event.inputs.version }}"
          echo "- ì‚¬ìœ : ${{ github.event.inputs.reason }}"
          
          # í˜„ìž¬ ë²„ì „ í™•ì¸
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # ë¡¤ë°± ëŒ€ìƒ ì»¤ë°‹ í™•ì¸
          TARGET_VERSION="${{ github.event.inputs.version }}"
          
          if [[ "$TARGET_VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # ë²„ì „ íƒœê·¸ë¡œ ë¡¤ë°±
            TARGET_COMMIT=$(git rev-list -n 1 "$TARGET_VERSION" 2>/dev/null || echo "")
          else
            # ì»¤ë°‹ í•´ì‹œë¡œ ë¡¤ë°±
            TARGET_COMMIT=$(git rev-parse --verify "$TARGET_VERSION^{commit}" 2>/dev/null || echo "")
          fi
          
          if [ -z "$TARGET_COMMIT" ]; then
            echo "âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ë²„ì „ ë˜ëŠ” ì»¤ë°‹: $TARGET_VERSION"
            exit 1
          fi
          
          echo "target-commit=$TARGET_COMMIT" >> $GITHUB_OUTPUT
          echo "âœ… ë¡¤ë°± ëŒ€ìƒ ê²€ì¦ ì™„ë£Œ: $TARGET_COMMIT"

      - name: ë¡¤ë°± ìŠ¹ì¸ í™•ì¸
        run: |
          echo "## âš ï¸ ë¡¤ë°± ì‹¤í–‰ ì˜ˆì •" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| í™˜ê²½ | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| í˜„ìž¬ ë²„ì „ | ${{ steps.validate.outputs.current-version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¡¤ë°± ëŒ€ìƒ | ${{ github.event.inputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ëŒ€ìƒ ì»¤ë°‹ | ${{ steps.validate.outputs.target-commit }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¡¤ë°± ì‚¬ìœ  | ${{ github.event.inputs.reason }} |" >> $GITHUB_STEP_SUMMARY

  # ìŠ¤í…Œì´ì§• ë¡¤ë°±
  rollback-staging:
    name: ìŠ¤í…Œì´ì§• ë¡¤ë°±
    runs-on: ubuntu-latest
    needs: pre-rollback-validation
    if: github.event.inputs.environment == 'staging'
    timeout-minutes: 15
    
    environment:
      name: staging
      url: https://eai-schema-staging.herokuapp.com
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ë¡¤ë°± ëŒ€ìƒ ì²´í¬ì•„ì›ƒ
        run: |
          git checkout ${{ needs.pre-rollback-validation.outputs.target-commit }}

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ë¡¤ë°± ë²„ì „ ë¹Œë“œ
        run: npm run build

      - name: Heroku CLI ì„¤ì¹˜
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh

      - name: ìŠ¤í…Œì´ì§• ë¡¤ë°± ì‹¤í–‰
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_STAGING_APP: eai-schema-staging
        run: |
          echo "machine api.heroku.com login _ password $HEROKU_API_KEY" > ~/.netrc
          echo "machine git.heroku.com login _ password $HEROKU_API_KEY" >> ~/.netrc
          chmod 600 ~/.netrc
          
          heroku git:remote -a "$HEROKU_STAGING_APP"
          
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action Rollback"
          
          git add -f dist/ package.json package-lock.json Procfile app.json
          git commit -m "Rollback to ${{ github.event.inputs.version }} - ${{ github.event.inputs.reason }} [skip ci]"
          
          git push heroku HEAD:main --force

      - name: ë¡¤ë°± ê²€ì¦
        run: |
          echo "ë¡¤ë°± ê²€ì¦ ëŒ€ê¸° ì¤‘..."
          sleep 30
          
          for i in {1..10}; do
            if curl -f -s https://eai-schema-staging.herokuapp.com/health > /dev/null; then
              echo "âœ… ìŠ¤í…Œì´ì§• ë¡¤ë°± ì„±ê³µ"
              exit 0
            fi
            echo "ê²€ì¦ ì‹œë„ $i/10 ì‹¤íŒ¨, 10ì´ˆ í›„ ìž¬ì‹œë„..."
            sleep 10
          done
          
          echo "âŒ ìŠ¤í…Œì´ì§• ë¡¤ë°± ê²€ì¦ ì‹¤íŒ¨"
          exit 1

  # í”„ë¡œë•ì…˜ ë¡¤ë°±
  rollback-production:
    name: í”„ë¡œë•ì…˜ ë¡¤ë°±
    runs-on: ubuntu-latest
    needs: pre-rollback-validation
    if: github.event.inputs.environment == 'production'
    timeout-minutes: 20
    
    environment:
      name: production
      url: https://eai-schema-api.herokuapp.com
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ë¡¤ë°± ëŒ€ìƒ ì²´í¬ì•„ì›ƒ
        run: |
          git checkout ${{ needs.pre-rollback-validation.outputs.target-commit }}

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: npm ci

      - name: ë¡¤ë°± ë²„ì „ ë¹Œë“œ
        run: npm run build

      - name: Heroku CLI ì„¤ì¹˜
        run: |
          curl https://cli-assets.heroku.com/install.sh | sh

      - name: í”„ë¡œë•ì…˜ ë¡¤ë°± ì‹¤í–‰
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_PRODUCTION_APP: eai-schema-api
        run: |
          echo "machine api.heroku.com login _ password $HEROKU_API_KEY" > ~/.netrc
          echo "machine git.heroku.com login _ password $HEROKU_API_KEY" >> ~/.netrc
          chmod 600 ~/.netrc
          
          heroku git:remote -a "$HEROKU_PRODUCTION_APP"
          
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action Rollback"
          
          git add -f dist/ package.json package-lock.json Procfile app.json
          git commit -m "PRODUCTION ROLLBACK to ${{ github.event.inputs.version }} - ${{ github.event.inputs.reason }} [skip ci]"
          
          git push heroku HEAD:main --force

      - name: í”„ë¡œë•ì…˜ ë¡¤ë°± ê²€ì¦
        run: |
          echo "í”„ë¡œë•ì…˜ ë¡¤ë°± ê²€ì¦ ëŒ€ê¸° ì¤‘..."
          sleep 60
          
          for i in {1..15}; do
            if curl -f -s https://eai-schema-api.herokuapp.com/health > /dev/null; then
              echo "âœ… í”„ë¡œë•ì…˜ ë¡¤ë°± ì„±ê³µ"
              exit 0
            fi
            echo "ê²€ì¦ ì‹œë„ $i/15 ì‹¤íŒ¨, 15ì´ˆ í›„ ìž¬ì‹œë„..."
            sleep 15
          done
          
          echo "âŒ í”„ë¡œë•ì…˜ ë¡¤ë°± ê²€ì¦ ì‹¤íŒ¨"
          exit 1

      - name: ê¸´ê¸‰ ì•Œë¦¼
        if: failure()
        run: |
          echo "## ðŸš¨ í”„ë¡œë•ì…˜ ë¡¤ë°± ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          echo "ì¦‰ì‹œ ìˆ˜ë™ ê°œìž…ì´ í•„ìš”í•©ë‹ˆë‹¤!" >> $GITHUB_STEP_SUMMARY
          echo "ë¡¤ë°± ëŒ€ìƒ: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "ì‹¤íŒ¨ ì‹œê°„: $(date -u)" >> $GITHUB_STEP_SUMMARY

  # ë¡¤ë°± í›„ ëª¨ë‹ˆí„°ë§
  post-rollback-monitoring:
    name: ë¡¤ë°± í›„ ëª¨ë‹ˆí„°ë§
    runs-on: ubuntu-latest
    needs: [rollback-staging, rollback-production]
    if: always() && (needs.rollback-staging.result == 'success' || needs.rollback-production.result == 'success')
    timeout-minutes: 15
    
    steps:
      - name: ë¡¤ë°± í™˜ê²½ ê²°ì •
        id: env
        run: |
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "url=https://eai-schema-api.herokuapp.com" >> $GITHUB_OUTPUT
            echo "env_name=í”„ë¡œë•ì…˜" >> $GITHUB_OUTPUT
          else
            echo "url=https://eai-schema-staging.herokuapp.com" >> $GITHUB_OUTPUT
            echo "env_name=ìŠ¤í…Œì´ì§•" >> $GITHUB_OUTPUT
          fi

      - name: ë¡¤ë°± í›„ ëª¨ë‹ˆí„°ë§
        run: |
          echo "${{ steps.env.outputs.env_name }} í™˜ê²½ ë¡¤ë°± í›„ ëª¨ë‹ˆí„°ë§ ì‹œìž‘..."
          
          # 10ë¶„ê°„ ì•ˆì •ì„± ëª¨ë‹ˆí„°ë§
          for i in {1..10}; do
            if curl -f -s ${{ steps.env.outputs.url }}/health > /dev/null; then
              echo "ëª¨ë‹ˆí„°ë§ $i/10: âœ… ì •ìƒ"
            else
              echo "ëª¨ë‹ˆí„°ë§ $i/10: âŒ ì˜¤ë¥˜ ê°ì§€"
              # ì¶”ê°€ ì•Œë¦¼ ë¡œì§ í•„ìš”ì‹œ êµ¬í˜„
            fi
            sleep 60
          done
          
          echo "âœ… ë¡¤ë°± í›„ ëª¨ë‹ˆí„°ë§ ì™„ë£Œ"

      - name: ë¡¤ë°± ì™„ë£Œ ë³´ê³ 
        run: |
          echo "## âœ… ë¡¤ë°± ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| í™˜ê²½ | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¡¤ë°± ë²„ì „ | ${{ github.event.inputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¡¤ë°± ì‚¬ìœ  | ${{ github.event.inputs.reason }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì™„ë£Œ ì‹œê°„ | $(date -u) |" >> $GITHUB_STEP_SUMMARY
          echo "| ìƒíƒœ | ì •ìƒ ìž‘ë™ ì¤‘ |" >> $GITHUB_STEP_SUMMARY